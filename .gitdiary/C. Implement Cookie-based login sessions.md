Let‚Äôs build **Step 2: Login + Cookie Authentication**, the part that turns your user records into *real authenticated sessions*.

We‚Äôll do this in a clean, production-like way:

- Configure authentication middleware
- Create a secure login endpoint
- Verify PBKDF2 hashed passwords securely
- Issue an auth cookie
- Protect routes with `[Authorize]`
- Add logout

### **Step 1 ‚Äî Configure Cookie Authentication**

ASP.NET uses authentication **schemes**. We're going to configure one scheme:

- **Cookie scheme**
- Persistent but secure
- HttpOnly
- Optional sliding expiration

In `Program.cs`:

```csharp
builder.Services.AddAuthentication("AppCookie")
    .AddCookie("AppCookie", options =>
    {
        options.Cookie.Name = "auth";
        options.Cookie.HttpOnly = true;
        options.LoginPath = "/auth/login";
        options.ExpireTimeSpan = TimeSpan.FromHours(1);
        options.SlidingExpiration = true;
    });

builder.Services.AddAuthorization();
```

And add the middleware:

```csharp
var app = builder.Build();

app.UseAuthentication();
app.UseAuthorization();
```

This is *mandatory* ‚Äî otherwise your `[Authorize]` attributes won‚Äôt work.

### **Step 2 ‚Äî Create the Login DTO**

```csharp
public class LoginRequest
{
    public string Username { get; set; } = default!;
    public string Password { get; set; } = default!;
}
```

### **Step 3 ‚Äî Implement Login Service**

We must:

1. Look up the user
2. Verify password using PBKDF2
3. (Later) handle lockout
4. Create a ClaimsPrincipal
5. Sign in via `HttpContext.SignInAsync`

Here is a clean login endpoint using Cookie auth:

```csharp
[HttpPost("login")]
public async Task<IActionResult> Login(LoginRequest request)
{
    // Login

    // Create claims
    var claims = new List<Claim>
    {
        new Claim(ClaimTypes.NameIdentifier, user.Id.ToString()),
        new Claim(ClaimTypes.Name, user.Username)
    };

    var identity = new ClaimsIdentity(claims, "AppCookie");
    var principal = new ClaimsPrincipal(identity);

    // Sign in (write auth cookie)
    await HttpContext.SignInAsync("AppCookie", principal);

    return Ok("Logged in successfully");
}
```

**Why this is production-grade**

‚úî Uses PBKDF2 verification

‚úî No username/password leak (same message on failure)

‚úî Cookies are HTTP-only

‚úî Cookies are generated by secure middleware

‚úî You control expiration + sliding behavior

**What the Cookie Contains (important)**

It does not store:

‚ùå password

‚ùå hash

‚ùå user object

It stores an encrypted, signed ticket with:

- User ID
- Username
- Auth scheme
- Expiration

The server validates it on each request.

ASP.NET crypto signs it using DataProtection API.

### **Step 4 ‚Äî Protecting Routes**

You can now protect any controller or endpoint with:

```csharp
[Authorize]
[HttpGet("me")]
public IActionResult GetMe()
{
    return Ok(new
    {
        UserId = User.FindFirstValue(ClaimTypes.NameIdentifier),
        Username = User.Identity?.Name
    });
}
```

Test this:

- Without logging in ‚Üí 401 Unauthorized
- After login ‚Üí works

### **Step 5 ‚Äî Logout Endpoint**

Cookie logout is simple:

```csharp
[HttpPost("logout")]
public async Task<IActionResult> Logout()
{
    await HttpContext.SignOutAsync("AppCookie");
    return Ok("Logged out");
}
```

### üß™ **Testing**

You can now:

1. Register
    
    POST `/auth/register`
    
    ```json
    {
      "username": "test",
      "email": "test@example.com",
      "password": "Password123!"
    }
    ```
    
2. Login
    
    POST `/auth/login`
    
    ```json
    {
      "username": "test",
      "password": "Password123!"
    }
    ```
    
    Should return ‚ÄúLogged in successfully‚Äù **and set an auth cookie**.
    
3. Access a protected route
    
    GET `/auth/me`
    
    Should return your user data.
    
4. Logout
    
    POST `/auth/logout`
    

### üéâ **You now have:**

A real authentication system with:

‚úî PBKDF2 password hashing

‚úî SQLite persistence

‚úî Login with cookies

‚úî Secure session management

‚úî Route protection

‚úî Logout

This is basically the core of a real identity system.
